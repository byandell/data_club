---
title: "Covariate"
output:
  html_document: default
  html_notebook: default
---

```{r libraries, message=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
```

### Learning Objectives

* examine covariates on their own
* plot relationships adjusting for covariates 
* determine how covariates change interpretation of relationships

### Read Phenotypes

Here we read in data and reduce to species with counts at least 10.

```{r read}
surveys <- read.csv("../data/portal_data_joined.csv")
## Remove missing data.
surveys_complete <- surveys %>%
  filter(species_id != "", !is.na(weight)) %>%
  filter(!is.na(hindfoot_length), sex != "")
# count records per species
species_counts <- surveys_complete %>%
  group_by(species_id) %>%
  tally
# get names of the species with counts >= 10
frequent_species <-  species_counts %>%
  filter(n >= 10) %>%
  select(species_id)
# filter out the less-frequent species
surveys_complete <- surveys_complete %>%
  filter(species_id %in% frequent_species$species_id)
```

Now focus on one genus, `Dipodomys`.

```{r}
surveys_dip <- surveys_complete %>%
  filter(genus == "Dipodomys")
```

### Relate Species to a Phenotype

The previous correlation study had a disturbing pattern that the data seemed to be from more than one group, which might be found with species. Here we examine one phenotype at a time with species, showing boxplots and densities.

```{r}
ggplot(surveys_dip,
       aes(x = species, y = weight)) +
  geom_jitter(col="lightgrey") +
  geom_boxplot() + 
  coord_flip()
```

```{r}
ggplot(surveys_dip,
       aes(x = weight, col = species, )) +
  geom_density()
```

Sometimes it is easier to see patterns by using facets.

```{r}
ggplot(surveys_dip,
       aes(x = weight, col = species, )) +
  geom_density() +
  facet_grid(species~.)
```

### Challenge

Make boxplots and density plots for `hindfoot_length`. How do these compare with the `weight` plots?

<-- end challenge -->

## Plot two phenotypes adjusting for species

```{r}
surveys_plot <- ggplot(surveys_dip, 
                       aes(x = weight, 
                           y = hindfoot_length,
                           col = species))
```

```{r}
surveys_plot + 
  geom_point(alpha = 1, shape = 1) +
  scale_color_brewer(type="qualitative", palette = "Paired") +
  scale_x_sqrt()
```

### Add a smooth and straight line

```{r}
surveys_plot + 
  geom_point(alpha = 1, shape = 1) +
  scale_color_brewer(type="qualitative", palette = "Paired") +
  scale_x_sqrt() +
  geom_smooth(se=FALSE, col="black") +
  geom_smooth(se=FALSE, col="red", method="lm")
```

This is not very satisfying. The straight line misses key aspects of the relationship, and the curved line, while going through the data, does this without explicit regard to species. Now we allow separate lines by species. Since our `surveys_plot` object already identifies color with species, the change is very simple.

```{r}
surveys_plot + 
  geom_point(alpha = 1, shape = 1) +
  scale_color_brewer(type="qualitative", palette = "Paired") +
  scale_x_sqrt() +
  geom_smooth(se=FALSE, method="lm")
```

It might be easier to see this in separate facets.

```{r}
surveys_plot + 
  geom_point(alpha = 1, shape = 1) +
  scale_color_brewer(type="qualitative", palette = "Paired") +
  scale_x_sqrt() +
  geom_smooth(se=FALSE, method="lm", col = "black") +
  facet_wrap(~species) +
  theme(legend.position="none")
```

### Adjusting correlation by covariate

For males and females separately, the correlation is somewhat different.

```{r}
surveys_dip %>%
  group_by(species) %>%
  summarize(cor = cor(weight, hindfoot_length))
```

Compare these with the overall correlation

```{r}
with(surveys_dip, cor(weight, hindfoot_length))
```

Thus, most of the correlation between `weight` and `hindfoot_length` can be explained by `species`.

### Adjusting group mean by other phenotype

We can turn this around and ask what is the mean for `log2(WBC)` by `Sex`.

```{r}
(surveys_mean <- surveys_dip %>%
  group_by(species) %>%
  summarize_at(vars(weight, hindfoot_length), mean))
```

We can add these to a plot with straight lines to verify that the regression lines go through the means.

```{r}
ggplot(surveys_dip, aes(x=weight, y=hindfoot_length, col=species)) +
  geom_point(alpha = 1, shape = 1) +
  scale_color_brewer(type="qualitative", palette = "Paired") +
  geom_smooth(method="lm", col="black") +
  geom_point(data = surveys_mean,
             aes(x=weight, y=hindfoot_length),
             size = 4, col = "black", shape = 1) +
  facet_wrap(~species) +
  theme(legend.position="none")
```

### Linear Model Fits with additive covariate

Here we repeat what we had before, but we provide an analysis of variance (ANOVA) summary wtih `anova()` rather than the usual `summary()`. We are using linear models and ANOVA without explaining many details. That would be a different lesson.

```{r}
fit <- lm(hindfoot_length ~ weight, surveys_dip)
anova(fit)
```

Now we add `species` to the model. Note that this model assumes the correlations within species are the same. Put another way, we assume the lines in plots are parallel.

```{r}
fit_species <- lm(hindfoot_length ~ species + weight, surveys_dip)
anova(fit_species)
```

We can formally compare these fits to see if we improved the fit.

```{r}
anova(fit,fit_species, test="F")
```

The p value `PR(>F)` shows that the fit is dramatically improved.

### Linear Model with interacting covariate

Are the slopes the same? Sometimes the relationship between two phenotypes shifts with level of a covarate. For instance, males and females have different correlations, and we want to account for that in our linear model. We do that by replacing the plus (`+`) with an asterisk (`*`).

```{r}
fit_species_int <- lm(hindfoot_length ~ species * weight, surveys_dip)
anova(fit_species_int)
```

We can compare this to the parallel line model.

```{r}
anova(fit_species, fit_species_int, test="F")
```

Notice that the `F` statistic is the same here as for the `species:weight` term in the earlier table. This interaction term, `species:weight`, is highly significant.
When there are significant interactions, it is difficult to interpret the main effects. It is usually best in that situation to report the significant interaction and then evaluate each level of the covariate (each sex in this case) separately.
That is, interaction means the relationship is different for different levels of the covariate, and you cannot interpret the relationship averaged over those levels.

Looking back at the plot, we see that for `merriami` species has a steeper slope.

### Recap

Correlation is useful to look for relationships, but it is important to consider other factors that might affect relationships. Sometimes a single value is adequate, but in this case the correlation between `weight` and `hindfoot_length` was confounded by `species`, and appeared stronger than it really is. That is, we were seeing correlation across species rather than within species.